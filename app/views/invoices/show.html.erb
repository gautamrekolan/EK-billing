<div class="breadcrumb">
  <<
  <%= link_to "INVOICES", invoices_path %>
</div>

<fieldset>
    <legend>Invoice Information</legend>
    <% if notice.blank? == false %>
        <p id="notice"><%= notice %></p>
    <% end %>
    <% if @warning.blank? == false %>
        <p id="warning"><%= @warning %></p>
    <% end %>
    <% if @pastdue_items.empty? == false %>
        <div id="pastdue">
            There are past due items on this customer's previous invoices. Consider adding to this invoice:
            <ul>
                <% @pastdue_items.each do |item| %>
                    <li><%= item %></li>
                <% end %>
            </ul>
        </div>
    <% end %>


    <div class="field">
        <label>Name</label>
        <%= @invoice.name %>
    </div>

    <div class="field">
        <label>Status</label>
        <% if @invoice.status.nil? == false %>
            <% if @invoice.status.blank? == false %>
                <%= @invoice.status %>
            <% else %>
                Opened on <%= @invoice.created_at.strftime("%B %e, %Y") %>
            <% end %>
        <% else %>
            Status is not available at this time.
        <% end %>
    </div>

    <div class="field">
        <label>Start date</label>
        <%= @invoice.start_date.strftime("%B %e, %Y") %>
    </div>

    <div class="field">
        <label>End date</label>
        <%= @invoice.end_date.strftime("%B %e, %Y") %>
    </div>

    <div class="field">
        <label>Issued date</label>
        <%= @invoice.issued_date.strftime("%B %e, %Y") %>
    </div>

    <div class="field">
        <label>Due date</label>
        <%= @invoice.due_date.strftime("%B %e, %Y") %>
    </div>

    <div class="field">
        <label>Amount</label>
        <%= number_to_currency(@invoice.amount) %>
    </div>

    <div class="field">
        <label>Notes</label>
        <% if @invoice.notes.blank? == false %>
            <%= @invoice.notes %>
        <% else %>
            There are no notes for this invoice.
        <% end %>
    </div>

    <div class="field" style="padding-bottom: 15px">
        <label>Customer</label>
        <%= link_to @invoice.customer.first_name + " " + @invoice.customer.last_name, @invoice.customer %>
    </div>

    <%= link_to 'Edit details', edit_invoice_path(@invoice), :class => 'link_button' %>
    <a href="#" class="link_button" onclick="confirm('Are you sure you want to delete this invoice?', '<%= invoice_delete_url(@invoice.id) %>')">Remove invoice</a>

    <fieldset style="margin-top: 20px; margin-bottom: 20px">
        <legend>Items</legend>
        <% if @invoice.status_code != 8 %>
            <p><%= link_to 'Add item', new_item_path(:invoice => @invoice.id) %></p>
        <% end %>
        <% if @invoice.items.empty? == false %>
        <table>
        <% @invoice.items.each do |item| %>
          <tr>
            <% String name = item.description %>
            <td><%= item.category.name %></td>
            <td><%= name %></td>
            <% if item.horse.nil? == false %>
                <td><%= item.horse.barn_name %></td>
            <% else %>
                <td>No horse associated</td>
            <% end %>
            <td><%= number_to_currency(item.amount) %></td>
            <td><%= link_to 'Edit', edit_item_path(item) %></td>
            <td><a href="#" onclick="confirm('Are you sure you want to delete this item?', '<%= item_delete_url(item.id) %>')">Remove</a></td>
          </tr>
        <% end %>
        </table>
        <% else %>
            <p>There are no items currently associated with this invoice.</p>
        <% end %>

        <% if @invoice.customer.autos.empty? == false %>
            <p style="margin-top: 15px; margin-bottom: 15px">*****************************************************************************************************<p>
            <p><%= link_to 'Add ALL auto items to this invoice', all_autos_path(:invoice => @invoice.id) %></p>
            <table>
              <% @invoice.customer.autos.each do |auto| %>
                <tr>
                    <td><%= link_to 'Add item', one_auto_path(:invoice => @invoice.id, :auto => auto.id) %></td>
                    <td><%= auto.description %></td>
                    <% if auto.horse.nil? == false %>
                        <td><%= auto.horse.barn_name %></td>
                    <% end %>
                    <td><%= number_to_currency(auto.amount)%></td>
                    <td><%= auto.start_date.strftime("%B %e, %Y") %></td>
                    <td><%= auto.end_date.strftime("%B %e, %Y") %></td>
                </tr>
              <% end %>
            </table>
        <% end %>
    </fieldset>

    <fieldset style="margin-bottom: 20px">
        <legend>Payments</legend>
        <% if @invoice.status_code != 8 %>
            <p><%= link_to 'Add payment', new_payment_path(:invoice => @invoice.id) %></p>
        <% end %>
        <% if @invoice.payments.empty? == false %>
        <table>
        <% @invoice.payments.each do |payment| %>
          <tr>
            <% String name = payment.payment_method + " " + payment.payment_notes %>
            <td><%= name %></td>
            <td><%= payment.date_received.strftime("%B %d, %Y") %></td>
            <td><%= number_to_currency(payment.payment_amount) %></td>
            <td><%= link_to 'Edit', edit_payment_path(payment) %></td>
            <td><a href="#" onclick="confirm('Are you sure you want to delete this payment?', '<%= payment_delete_url(payment.id) %>')">Remove</a></td>
          </tr>
        <% end %>
        </table>
        <% else %>
            <p>There are no payments currently associated with this invoice.</p>
        <% end %>
    </fieldset>

    <fieldset style="margin-bottom: 20px">
        <legend>Actions</legend>
        <% if @invoice.statuses.empty? == false %>
        <table>
        <% @invoice.statuses.each do |status| %>
          <tr>
            <td><%= status.status %></td>
            <td><%= status.created_at.strftime("%B %e, %Y") %></td>
          </tr>
        <% end %>
        </table>
        <% else %>
            <p>There are no actions currently associated with this invoice.</p>
        <% end %>
    </fieldset>

    <%= link_to 'Download as PDF', invoice_path(@invoice, :format => :pdf), :class => 'link_button' %>
    <% if @invoice.status == "Opened" && @invoice.customer.email.blank? == false %>
        <%= link_to 'Email invoice', invoice_email_path(:invoice => @invoice.id), :class => 'link_button'  %>
    <% elsif @invoice.status == "Opened" && @invoice.customer.delivery_method == "Mail" %>
        <%= link_to 'Mark as mailed', invoice_mailed_path(:invoice => @invoice.id, :method => "primary"), :class => 'link_button' %>
    <% end %>
    <% if (@invoice.status == "Emailed" || @invoice.status == "Confirmed" || @invoice.status == "Mailed (Secondary)" || @invoice.status == "Partially Paid" || @invoice.status == "Reminded") && @invoice.customer.email.blank? == false %>
        <%= link_to 'Email a reminder', invoice_reminder_path(:invoice => @invoice.id), :class => 'link_button' %>
    <% end %>
    <% if (@invoice.status == "Emailed" || @invoice.status == "Confirmed" || @invoice.status == "Mailed (Secondary)" || @invoice.status == "Partially Paid" || @invoice.status == "Reminded") && @invoice.customer.phone.blank? == false %>
        <%= link_to 'Text a reminder', invoice_text_path(:invoice => @invoice.id), :class => 'link_button' %>
    <% end %>
    <% if @invoice.status == "Mail Requested" %>
        <%= link_to 'Mark as mailed', invoice_mailed_path(:invoice => @invoice.id), :class => 'link_button'  %>
    <% end %>
    <% if @invoice.status != "Paid" %>
        <%= link_to 'Mark as paid', invoice_paid_path(:invoice => @invoice.id), :class => 'link_button' %>
    <% end %>
</fieldset>